#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"
require "speculation"
require "speculation/test"
require "speculation/gen"
require "speculation/utils_specs"

# You can add fixtures and/or initialization code here to make experimenting
# with your gem easier. You can also use a different console, if you like.
def reload!
  STest.unstrument if Object.const_defined?(:STest)

  [:Speculation, :S, :STest, :Gen, :U, :H, :V].each do |const|
    Object.send :remove_const, const if Object.const_defined?(const)
  end

  load "./lib/speculation/namespaced_symbols.rb"
  load "./lib/speculation/conj.rb"
  load "./lib/speculation/identifier.rb"
  load "./lib/speculation/utils.rb"
  load "./lib/speculation/error.rb"

  load "./lib/speculation/spec_impl.rb"

  Dir["lib/speculation/spec_impl/*.rb"].each do |f|
    load f
  end

  load "./lib/speculation.rb"
  load "./lib/speculation/gen.rb"
  load "./lib/speculation/test.rb"
  load "./lib/speculation/utils_specs.rb"

  Object.const_set(:S, Speculation)
  Object.const_set(:STest, Speculation::Test)
  Object.const_set(:Gen, Speculation::Gen)
  Object.const_set(:U, Speculation::Utils)
  Object.const_set(:H, Hamster::Hash)
  Object.const_set(:V, Hamster::Vector)

  STest.instrument
end

reload!

# allow running minitest assertions
require "minitest"
include Minitest::Assertions
def self.assertions; 1; end
def self.assertions=(_x); end
using Speculation::NamespacedSymbols.refine(self)

# (If you use this, don't forget to add pry to your Gemfile!)
require "pry"
Pry.start
